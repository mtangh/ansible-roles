---
# test-setup tasks file

- block:

  - name: "{{ test_casename|d('noname') }} | test-setup | Include vars."
    include_vars:
      file: "{{ '%s/vars/%s.yml'|format(test_root_dir,item) }}"
    with_items:
    - main
    - "{{ test_casename }}"
    when: ('%s/vars/%s.yml'|format(test_root_dir,item))|is_file
    changed_when: no

  - name: "{{ test_casename|d('noname') }} | test-setup | cleanup."
    file:
      path: "{{ test_prefix_dir }}"
      state: absent
      force: yes
    changed_when: no

  - name: "{{ test_casename|d('noname') }} | test-setup | Create a prefix directories."
    file:
      path: "{{ test_prefix_dir }}"
      state: directory
      owner: "{{ test_owner }}"
      group: "{{ test_group }}"
      mode: "0755"

  - name: "{{ test_casename|d('noname') }} | test-setup | Create directories for test."
    file:
      path: "{{ '%s%s'|format(test_prefix_dir,item.path|d(item)) }}"
      state: directory
      owner: "{{ item.owner|d(test_owner) }}"
      group: "{{ item.group|d(test_group) }}"
      mode: "{{ item.mode|d('0755') }}"
    with_items: "{{ test_setup_mkdirs|d([]) }}"
    when: item|d(none) is not none
    ignore_errors: yes

  - name: "{{ test_casename|d('noname') }} | test-setup | Copy files."
    synchronize:
      src: "{{ item }}/"
      dest: "{{ test_prefix_dir }}"
      checksum: no
      compress: yes
      delete: yes
      links: yes
      recursive: yes
    with_first_found:
    - files:
      - "{{ '%s/%s/%s'|format(test_setupfiles_dir,test_casename,os_spec_os_family|d('X')) }}"
      - "{{ '%s/%s'|format(test_setupfiles_dir,test_casename) }}"
      - "{{ '%s/%s'|format(test_setupfiles_dir,os_spec_os_family|d('X')) }}"
      - "{{ '%s/default'|format(test_setupfiles_dir) }}"
      skip: yes
    when: test_setupfiles_dir|is_dir == true
          and test_prefix_dir|d('')|is_dir == true
    ignore_errors: yes

  when: test_run|d(false)
  no_log: yes
  tags:
  - '[test-setup]'
